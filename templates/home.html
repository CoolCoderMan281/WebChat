<!-- FILEPATH: /workspaces/WebChat/templates/home.html -->

<!--
    This HTML file represents the home page of a web chat application.
    It contains a sidebar to display channels, input fields for username and message,
    and a button to send the message.
    The JavaScript code handles fetching channels, sending messages, and handling network errors.
-->
<!DOCTYPE html>
<html>
<head>
    <title>Home</title>
    <style>
        body {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #333;
            color: #fff;
        }
        
        .sidebar {
            width: 10%;
            background-color: #222;
            padding: 20px;
            height: 100%; /* Add this line to set the height of the sidebar */
            position: fixed;
            left: 0;
        }
        
        .channel {
            margin-bottom: 10px;
        }
        
        .channel a {
            text-decoration: none;
            color: #fff;
        }
        
        .channel a:hover {
            color: #ccc;
        }

        .messages {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            overflow-y: auto;
            flex-grow: 1; /* Add this line to make the messages container take up all available space */
            padding: 20px;
            background-color: #444; /* Modify this line to set the background color */
            margin-top: 20px;
            margin-bottom: 60px; /* Adjust this value to leave enough space for the bottom bar */
            width: 86%; /* Modify this line to set the width of the messages box */
            margin-left: auto; /* Add this line to anchor the messages box to the right */
            margin-right: 0; /* Add this line to remove any right margin */
        }

        .message {
            margin-bottom: 10px;
        }

        .message .time {
            font-size: 12px;
            color: #ccc;
        }

        .message .username {
            font-weight: bold;
            color: #fff;
        }

        .message .content {
            color: #fff;
        }

        .bottom-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            background-color: #222;
            padding: 20px;
            position: fixed;
            bottom: 0;
            height: 5vh; /* Modify this line to set the height of the bottom bar */
        }

        .input-container {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex-grow: 1; /* Add this line to make the input container take up remaining space */
        }

        .input-container label {
            color: #fff;
        }

        .input-container input {
            margin-top: 5px;
            width: 100%; /* Add this line to set the width of the input field */
            height: 40px; /* Modify this line to set the height of the input field */
        }

        .send-button {
            margin-top: 10px;
            width: 10%; /* Add this line to set the width of the send button */
        }

        /* Add this CSS rule to confine the username box to the sidebar */
        .input-container input#usernameInput {
            width: 100%;
        }

        /* Add this CSS rule to style the username input */
        .username-input {
            width: 10%; /* Add this line to set the width of the username input */
        }

        /* Add this CSS rule to style the message input */
        .message-input {
            width: 95%; /* Add this line to set the width of the message input */
        }
    </style>
    <script>
        var channelId = "default"; // Define channelId at a global scope with the default value "default"
        
        function getChannels() {
            // Create a new XMLHttpRequest object
            var xhr = new XMLHttpRequest();
            // Set the request method and URL
            xhr.open("GET", "/getChannels", true);

            // Set the authorization header
            xhr.setRequestHeader("Authorization", authToken);

            // Send the request
            xhr.send();

            // Listen for the response
            xhr.onload = function() {
                    if (xhr.status === 200) {
                        // Parse the response JSON
                        var response = JSON.parse(xhr.responseText);
                        var channels = response.channels;

                        // Get the sidebar element
                        var sidebar = document.getElementById("sidebar");

                        // Clear the sidebar
                        sidebar.innerHTML = "";

                        // Add the "Channels: " header
                        var channelsHeader = document.createElement("div");
                        channelsHeader.textContent = "Channels: ";
                        sidebar.appendChild(channelsHeader);

                        // Add each channel to the sidebar
                        channels.forEach(function(channel) {
                            var channelElement = document.createElement("div");
                            channelElement.classList.add("channel");

                            var channelLink = document.createElement("a");
                            channelLink.href = "#";
                            channelLink.textContent = "#" + channel; // Add "#" to the start of the channel name

                            channelLink.addEventListener("click", function() {
                                // Set the channelId variable to the channel's id
                                channelId = channel;
                                refreshMessages();
                            });

                            channelElement.appendChild(channelLink);
                            sidebar.appendChild(channelElement);
                        });
                    } else {
                        // Display an error message to the user
                        alert("Failed to get channels. Please try again later.");
                    }
                };

            // Listen for any network errors
            xhr.onerror = function() {
                // Display an error message to the user
                alert("Network error occurred. Please check your internet connection and try again.");
            };
        }
        
        function sendMessage() {
            // Get the message and username from the input fields
            var message = document.getElementById("messageInput").value;
            //var username = document.getElementById("usernameInput").value;

            // Get the messages container element
            var messagesContainer = document.getElementById("messagesContainer");

            // Create a new XMLHttpRequest object
            var xhr = new XMLHttpRequest();

            // Set the request method and URL
            xhr.open("POST", "/sendMessage", true);

            // Set the authorization header
            xhr.setRequestHeader("Authorization", authToken);

            // Set the request header
            xhr.setRequestHeader("Content-Type", "application/json");

            // Set the request body
            var requestBody = JSON.stringify({ message: message, channelId: channelId });

            // Send the request
            xhr.send(requestBody);

            // Listen for the response
            xhr.onload = function() {
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    if (response.acknowledgment !== 'Message received') {
                        alert("Message delivery failed. Please try again later.\n\nServer response: " + response.acknowledgment);
                    } else {
                        refreshMessages();
                        // Clear the message input field
                        document.getElementById("messageInput").value = "";
                    }
                } else {
                    // Display an error message to the user
                    alert("Failed to deliver message. Please try again later.");
                }
            };

            // Listen for any network errors
            xhr.onerror = function() {
                // Display an error message to the user
                alert("Network error occurred. Please check your internet connection and try again.");
            };
        }

        function refreshMessages() {
            // Create a new XMLHttpRequest object
            var xhr = new XMLHttpRequest();
            // Set the request method and URL
            xhr.open("GET", "/messages/" + channelId, true);

            // Set the authorization header
            xhr.setRequestHeader("Authorization", authToken);

            // Send the request
            xhr.send();

            // Listen for the response
            xhr.onload = function () {
                if (xhr.status === 200) {
                    // Parse the response JSON
                    var response = JSON.parse(xhr.responseText);
                    var messages = response.messages;

                    if (messages.length == 0)
                    {
                        return;
                    }
                    console.log(messages);
                    // using a loop print every message
                    for (var i = 0; i < messages.length; i++) {
                        console.log(messages[i].username + " | " + messages[i].message + " | " + messages[i].timestamp + " | " + messages[i].id + " | " + messages[i].edited);
                    }

                    // Get the messages container element
                    var messagesContainer = document.getElementById("messagesContainer");

                    // Check if the scroll is already at the bottom
                    var isAtBottom = messagesContainer.scrollHeight - messagesContainer.clientHeight <= messagesContainer.scrollTop + 1;

                    // Clear the messages container
                    messagesContainer.innerHTML = "";

                    // Add each message to the messages container
                    messages.forEach(function (message) {
                        var messageElement = document.createElement("div");
                        messageElement.classList.add("message");

                        var usernameElement = document.createElement("div");
                        usernameElement.classList.add("username");
                        usernameElement.textContent = message.username + " | " + message.timestamp;

                        var editButton = document.createElement("button"); // Create the edit button
                        editButton.classList.add("edit-button");
                        editButton.textContent = "Edit";
                        editButton.addEventListener("click", function() {
                            // Call the /editMessage route here
                            // You can use XMLHttpRequest or fetch API to make the request
                            // Example using fetch API:
                            newCon = prompt("New message: ");
                            if (newCon == null || newCon == "") {
                                return;
                            }
                            fetch("/editMessage", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "Authorization": authToken
                                },
                                body: JSON.stringify({ "id": message.id, "newContent": newCon }) // Pass the message ID and new content to the server
                            })
                            .then(function(response) {
                                // Handle the response
                                if (response.ok) {
                                    // Edit successful, handle the response accordingly
                                } else {
                                    // Edit failed, handle the response accordingly
                                }
                            })
                            .catch(function(error) {
                                // Handle any network or request error
                            });
                        });

                        var contentElement = document.createElement("div");
                        contentElement.classList.add("content");
                        if (message.edited == false)
                        {
                            contentElement.textContent = message.message;
                        } else {
                            contentElement.textContent = message.message + " (edited)";
                        }

                        usernameElement.appendChild(editButton); // Add the edit button to the username element

                        messageElement.appendChild(usernameElement);
                        messageElement.appendChild(contentElement);

                        messagesContainer.appendChild(messageElement);
                    });

                    // Scroll down to the new bottom if already at the bottom
                    if (isAtBottom) {
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                } else {
                    // Display an error message to the user
                    console.log("Failed to get messages. Please try again later.");
                }
            };

            // Listen for any network errors
            xhr.onerror = function () {
                // Display an error message to the user
                console.log("Network error occurred. Please check your internet connection and try again.");
            };
        }

        // Get auth token
        var authToken =  "{{ token }}";

        // Call the getChannels function to populate the sidebar
        getChannels();

        // Call refreshMessages to first populate messages
        refreshMessages();

        // Call the refreshMessages function every 3 seconds
        setInterval(refreshMessages, 3000);
        setInterval(getChannels, 5000);
    </script>
</head>
<body>
    <div id="sidebar" class="sidebar">
        <label for="channels">Channels:</label>
        <div id="channels"></div> <!-- Add the channels container -->
    </div>
    </div>
    <div class="bottom-bar">
        <div class="input-container message-input"> <!-- Add the message-input class to the input container -->
            <input type="text" id="messageInput" placeholder="Enter your message" onkeydown="if(event.keyCode === 13) sendMessage()">
        </div>
    </div>
    <div class="messages" id="messagesContainer"></div>
</body>
</html>
