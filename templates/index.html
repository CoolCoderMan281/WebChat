<!DOCTYPE html>
<html>
<head>
    <title>What the sigma</title>
</head>
<body>
    <style>
        body {
            display: flex;
            height: 100vh;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            overflow: hidden; /* Add this line */
        }

        #sidebar {
            width: 10vw;
            height: 100%;
            position: relative;
            border-right: 1px solid #000;
        }

        #channels {
            height: 80%;
            overflow-y: auto;
        }

        #profile-badge {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 5vh; /* Set the height to 5vh */
            border-top: 1px solid #000; /* Add a border to the top of the div */
            display: flex; /* Use flexbox */
            align-items: center; /* Center items vertically */
            padding: 0 10px; /* Add some padding on the left and right */
        }

        #profile-picture {
            width: 4vh; /* Set the width */
            height: 4vh; /* Set the height */
            border-radius: 50%; /* Make the image rounded */
            margin-right: 10px; /* Add some margin on the right */
        }

        #user-name {
            /* Other styles */
            overflow: hidden; /* Hide overflowed content */
            text-overflow: ellipsis; /* Indicate overflowed content with an ellipsis */
            white-space: nowrap; /* Prevent the text from wrapping to a new line */
        }

        #main {
            width: calc(100% - 10vw); /* Full width of the viewport minus the width of the sidebar */
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        #top-banner {
            height: 2.5vh; /* 2.5% of the viewport height */
            border-bottom: 1px solid #000;
            display: flex; /* Use flexbox */
            align-items: center; /* Center items vertically */
            justify-content: center; /* Center items horizontally */
        }

        #messages {
            height: calc(100% - 2.5vh - 5vh); /* Full height of the #main div minus the heights of the #top-banner and #message-input divs */
            overflow-y: auto;
        }

        #message-input {
            height: 5vh; /* Set the height to 5vh */
            border-top: 0px solid #000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
        }

        #emoji-button {
            width: 5vh; /* Same as the height of #message-input */
            height: 5vh; /* Same as the height of #message-input */
            position: absolute; /* This will position the button relative to #message-input */
            right: 0; /* This will anchor the button to the right edge of #message-input */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%; /* Make the button rounded */
        }

        #input-field {
            width: 100%; /* Make the input field take up the full width of #message-input */
            height: 100%;
            padding-right: 5vh; /* Prevent text from being covered by the emoji button */
            white-space: pre-wrap; /* Make the text wrap onto the next line */
        }
    </style>
    <div id="sidebar">
        <div id="channels">
            <!-- Channels will be loaded here -->
            <p>Yo</p>
        </div>
        <div id="profile-badge">
            <img id="profile-picture" src="{{ profileUrl }}" alt="Profile Picture">
            <span id="user-name">{{ username }}</span>
        </div>
    </div>
    <div id="main">
        <div id="top-banner">
            <!-- The selected channel's name will be displayed here -->
            <p>{{selectedChannel}}</p>
        </div>
        <div id="messages">
            <!-- Messages will be displayed here -->
            <p>What the sigma?</p>
        </div>
        <div id="message-input">
            <input type="text" id="input-field" placeholder="Type a message...">
            <button id="emoji-button">ðŸ˜€</button>
        </div>
    </div>
    <script>
        var selectedChannel = "";
        var currentChannels = [];
        var currentFriends = [];

        // Define the fetch operation in a separate function
        function fetchChannels() {
            // Fetch the channels
            fetch('/channels')
                .then(response => {
                    if (!response.ok || response.url.includes("/login")) {
                        window.location.href = "/login";
                        return;
                    }
                    return response.json();
                })
                .then(data => {
                    // Check if channels or friends have changed
                    if (JSON.stringify(data.channels) !== JSON.stringify(currentChannels) || JSON.stringify(data.friends) !== JSON.stringify(currentFriends)) {
                        // Update currentChannels and currentFriends
                        currentChannels = data.channels;
                        currentFriends = data.friends;
                        
                        if (selectedChannel == "")
                        {
                            selectedChannel = currentChannels[0];
                            const topBanner = document.getElementById('top-banner');
                            topBanner.textContent = "#" + selectedChannel;
                        }

                        // Clear the channels div
                        const channelsDiv = document.getElementById('channels');
                        channelsDiv.innerHTML = '';

                        data.channels.forEach(channel => {
                            const channelElement = document.createElement('p');
                            channelElement.textContent = "#" + channel;

                            // Add click event listener
                            channelElement.addEventListener('click', () => {
                                console.log(`Channel ${channel} was clicked`);
                                selectedChannel = channel;

                                // Update top banner
                                const topBanner = document.getElementById('top-banner');
                                topBanner.textContent = "#" + selectedChannel;
                            });

                            channelsDiv.appendChild(channelElement);
                        });

                        // Append friends at the bottom
                        data.friends.forEach(friend => {
                            const friendElement = document.createElement('p');
                            friendElement.textContent = "@" + friend.username;

                            // Add click event listener
                            friendElement.addEventListener('click', () => {
                                console.log(`Friend ${friend.username} was clicked`);
                                selectedChannel = friend.username;

                                // Update top banner
                                const topBanner = document.getElementById('top-banner');
                                topBanner.textContent = "@" + selectedChannel;
                            });

                            channelsDiv.appendChild(friendElement);
                        });
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // Call the function once when the page loads
        fetchChannels();

        // Then call it every 5 seconds
        setInterval(fetchChannels, 5000);
    </script>
</body>
</html>